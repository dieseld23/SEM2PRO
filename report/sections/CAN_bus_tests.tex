%!TEX root = ../main.tex

\subsection{CAN Bus Tests}
With the CAN controller available on the PS of the Zybo, the CAN bus will be tested to determine the transmission abilities of the network.
The transceivers are able to work at up to 8 Mb/s, while the CAN controllers on the Zybo only guarantee functionality up to 1 Mb/s. 
As the final implementation should be done in PL, there is nothing preventing the controller working at 8 Mb/s -- the FPGA can easily produce and interpret signals up to or beyond 8 Mb/s.

\paragraph{Latency tests}
For this test, only two Zybos are needed.
One node prepares a frame for transmission, then sets a GPIO pin high.
The other node will then wait for the full message frame to be received, and then set its GPIO pin high.
Using an oscilloscope, it is possible to measure the time it takes to send a message.\\

The test needs to be run for the largest and smallest frames, that is one with 8 bytes of data, and one without data. 
The messages will be constructed, so that bit stuffing doesn't occur by writing 0x55 or 0xAA for each byte. 

\paragraph{Bandwidth}
This will be calculated, as the faster controllers are not available.
Bandwidth is considering the amount of net data being transmitted per unit time, when excluding the overhead.
Bandwidth will be calculated for 8 byte frames, and bit stuffing will be omitted.\\

The maximum operating data rate for the transceivers is 8 Mb/s.
As mentioned in section~\ref{sub:CanMessageFrame}, the CAN frame 47 bits of overhead. 
Including 8 bytes of data, this comes up to 111 bits. 
Time per frame is:

\begin{equation}
\frac{111}{8 \cdot 10^6} = 1.39 \cdot 10^-5
\end{equation}

As each frame contains 8 bytes of data, the data rate becomes:

\begin{equation}
\frac{8}{1.39 \cdot 10^-5}= 5.77 \cdot 10^5
\end{equation}

That means, that the effective transfer rate is 577 kB/s, or 4.61 Mb/s

\paragraph{Message filtering}
Three Zybos will be needed for this test.
One will act as a transmitter, and the two others will receive messages.\\
The transmitting node will shift back and forth between three message IDs, and write a recursive message, i.e. counting up from zero.
One receiving node will only accept one message ID, the other node will only accept another message ID, and the third message ID will be ignored by both.


\paragraph{Priority when multiple node sending}
Two Zybos will be needed for this test.
Both Zybos will be prompted to send a message when an interrupt occurs on an input pin. 
The data part of the messages don't matter, but the message IDs do; they need to be different.
Zybo A will send the message ID 0b10101000000.
Zybo B will have the message ID 0b10101010000.
That means, that Zybo A has higher priority, and Zybo B will stop trying to send a message when the seventh bit occurs, and receive instead.
It is assumed, that once Zybo A is done sending, (and its frame is acknowledged), Zybo B will succesfully retry its transmission. 